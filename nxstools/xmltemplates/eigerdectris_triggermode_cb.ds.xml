<?xml version='1.0'?>
<definition>
  <datasource type="PYEVAL" name="$(name)_triggermode_cb">
    <result name="result">
import PyTango
import pni.io.nx.h5 as nx

hostname = "$(hostname)"
device = "$(device)"
host, port = hostname.split(":")
port = int(10000)
edb = PyTango.Database(host, port)

sl = edb.get_server_list("EigerDectris/*")
writer = None
for ms in sl:
    devserv = edb.get_device_class_list(ms).value_string
    if device in devserv:
        dev = devserv[0::2]
        serv = devserv[1::2]
        for idx, ser in enumerate(serv):
            if ser == 'EigerFilewriter':
                writer = dev[idx]
                break
wp = PyTango.DeviceProxy('%s/%s' % (hostname, writer))
filepattern = wp.FilenamePattern.split("/")[-1]
imagesperfile = wp.ImagesPerFile
if "$var.filename":
    path = ("$var.filename").split("/")[-1].split(".")[0] + "/"
else:
    path = ""
#path += '%s/%s_master.h5://entry' % ($(name), filepattern)
path += '%s/%s_' % ("$(name)", filepattern)
tmode = ds.$(name)_triggermode
totnbimages = sum(commonblock["$(name)_stepindex"])
nbfiles = (totnbimages + imagesperfile - 1) // imagesperfile
ds.result = tmode.lower()
root = commonblock["__nxroot__"]
en = root.open("entry$var.serialno")
dt = en.open("data")
ins = en.open("instrument")
det = ins.open("$(name)")
col = det.open("collection")
for nbf in range(1, nbfiles+1):
    nx.link("%sdata_%06i.h5://entry/data/data" % (path, nbf), col, "data_%06i" % nbf)
    nx.link("/entry$var.serialno/instrument/$(name)/collection/data_%06i" % nbf, dt, "data_%06i" % nbf)
    </result>
    $datasources.$(name)_triggermode
    $datasources.$(name)_nbimages
    $datasources.$(name)_nbtriggers
    
  </datasource>
</definition>
